<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>QR Code AR Loader</title>
    <meta name="description" content="Load AR models using QR codes.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-tools/ar.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* Basic styling for layout */
        body {
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
            font-family: sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #qr-scanner-container {
            text-align: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #qr-scanner-container h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #reader {
            width: 100%; /* Make scanner responsive */
            max-width: 400px; /* Max width for scanner */
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden; /* Ensure video stays within bounds */
        }

        #qr-scanner-results {
            margin-top: 20px;
            font-size: 1.1em;
            color: #555;
        }

        /* Initially hide the AR scene container */
        #ar-scene-container {
            display: none;
            width: 100%;
            height: 100vh; /* Take full viewport height */
            position: absolute; /* Cover the whole screen */
            top: 0;
            left: 0;
        }

        /* Style for the AR scene itself */
        #ar-scene {
            width: 100%;
            height: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            #qr-scanner-container {
                padding: 15px;
            }
            #qr-scanner-container h1 {
                font-size: 1.5em;
            }
            #qr-scanner-results {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>

    <div id="qr-scanner-container">
        <h1>Scan QR Code to Load AR Model</h1>
        <div id="reader"></div>
        <div id="qr-scanner-results">Scanning...</div>
    </div>

    <div id="ar-scene-container">
        <a-scene
            id="ar-scene"
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            arjs='sourceType: webcam; detectionMode: mono; trackingMethod: best;'
            embedded
            inspector="url: https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js;"
            loading-screen="enabled: false;"
        >

            <a-marker id="dynamic-marker" type="unknown">
                <a-entity
                    id="dynamic-model"
                    scale="0.5 0.5 0.5"  position="0 0 0"    rotation="0 0 0"
                >
                    </a-entity>
            </a-marker>

            <a-entity camera></a-entity>

        </a-scene>
    </div>

    <script>
        // Get references to the HTML elements
        const qrScannerContainer = document.getElementById('qr-scanner-container');
        const arSceneContainer = document.getElementById('ar-scene-container');
        const qrScannerResults = document.getElementById('qr-scanner-results');
        const dynamicMarker = document.getElementById('dynamic-marker');
        const dynamicModel = document.getElementById('dynamic-model');
        const arScene = document.getElementById('ar-scene');

        // Configuration for html5-qrcode
        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Function called when a QR code is successfully scanned
        const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`QR Code scanned: ${decodedText}`);
            qrScannerResults.textContent = `Scanned: ${decodedText}`;

            // Stop the QR scanner
            html5QrCode.stop().then(() => {
                console.log("QR scanner stopped.");

                // Use the decoded text (model name) to determine the model and pattern file
                const modelName = decodedText;
                const modelUrl = `./models/${modelName}.gltf`; // Assuming .gltf format and models in ./models/
                const patternUrl = `./patterns/${modelName}.patt`; // Assuming patterns in ./patterns/

                // Update the AR marker and model
                dynamicMarker.setAttribute('type', 'pattern');
                dynamicMarker.setAttribute('url', patternUrl);
                dynamicModel.setAttribute('gltf-model', modelUrl);

                // Hide the scanner and show the AR scene
                qrScannerContainer.style.display = 'none';
                arSceneContainer.style.display = 'block';

                // AR.js should start automatically when the scene is visible,
                // but sometimes a small delay or manual kick might be needed
                // depending on the browser and device.
                // For robustness, you might want to ensure the AR scene is fully
                // initialized or wait a moment here if issues arise.
                console.log("Switched to AR scene.");

            }).catch(err => {
                // Stop failed, handle it.
                console.error("Failed to stop QR scanner:", err);
                qrScannerResults.textContent = `Error stopping scanner: ${err}`;
            });
        };

        // Function called if there's an error during scanning
        const onScanError = (errorMessage) => {
            // You can log errors, but avoid showing them constantly to the user
            // console.warn(`QR Code scanning error: ${errorMessage}`);
            // qrScannerResults.textContent = `Scanning error: ${errorMessage}`; // Optional: show error
        };

        // Start the QR scanner when the window loads
        window.onload = function() {
             // Request camera permission and start scanning
            html5QrCode.start({ facingMode: "environment" }, qrCodeConfig, onScanSuccess, onScanError)
            .catch(err => {
                // Handle errors related to camera access or initialization
                console.error("Error starting QR scanner:", err);
                qrScannerResults.textContent = `Error starting scanner: ${err}. Please ensure camera access is granted.`;
            });
        };

        // Optional: Add a way to switch back to scanner if needed (e.g., a button in the AR scene)
        // This is not included in this basic example but would involve reversing the display logic.

    </script>

</body>
</html>
