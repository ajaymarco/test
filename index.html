<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code AR Model Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #ar-container {
            position: relative; /* Make sure the container is a positioning context */
            width: 100%;
            height: 100vh;
            overflow: hidden; /* Prevent scrollbars */
        }
        #video-feed {
            position: fixed; /* Overlay the entire window */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensure video covers the whole area */
            z-index: 1;
        }
        #ar-scene {
            position: absolute; /* Position absolutely within the container */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* The scene will be manipulated by AR.js, but we can style it here if needed */
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        }
        .scanning-animation {
            border: 4px solid #4CAF50; /* Green border */
            border-radius: 16px;
            width: 200px;
            height: 200px;
            animation: scanning 2s linear infinite; /* Apply the animation */
        }
        @keyframes scanning {
            0% {
                transform: translateY(-100px);
            }
            50% {
                transform: translateY(100px);
            }
            100% {
                transform: translateY(-100px);
            }
        }
        .model-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4; /* Ensure model is above the video */
            width: 200px; /* Initial size, can be adjusted */
            height: 200px;
            /* Add styling for your 3D model here */
        }
        #error-message, #model-load-error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 16px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1rem;
        }
        #success-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 255, 0, 0.8);
            color: white;
            padding: 16px;
            border-radius: 8px;
            z-index: 10;
            font-size: 1rem;
        }

    </style>
</head>
<body class="bg-gray-100">
    <div id="ar-container">
        <video id="video-feed" autoplay playsinline></video>
        <div id="ar-scene"></div>
        <div id="scanning-overlay" class="overlay flex flex-col items-center justify-center">
            <div class="scanning-animation"></div>
            <p class="mt-4 text-white text-lg">Scanning for QR Code...</p>
        </div>
        <div id="model-container" class="model-container">
            </div>
        <div id="error-message" class="hidden"></div>
        <div id="model-load-error-message" class="hidden"></div>
        <div id="success-message" class="hidden"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.139.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.139.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        const arContainer = document.getElementById('ar-container');
        const videoFeed = document.getElementById('video-feed');
        const arScene = document.getElementById('ar-scene');
        const scanningOverlay = document.getElementById('scanning-overlay');
        const modelContainer = document.getElementById('model-container');
        const errorMessageElement = document.getElementById('error-message');
        const modelLoadErrorMessageElement = document.getElementById('model-load-error-message');
        const successMessageElement = document.getElementById('success-message');

        let arInitialized = false;
        let qrCodeFound = false;
        let modelLoaded = false;
        let modelViewer; // Will hold the Three.js scene and camera.
        let gltfModel; // Will hold the loaded GLTF model.
        let modelName = '';

        // GitHub repository details
        const githubRepoOwner = 'YOUR_GITHUB_USERNAME';  // Replace with your GitHub username
        const githubRepoName = 'YOUR_REPO_NAME';        // Replace with your repository name
        const githubRepoPath = 'models/';           // Path to the models folder in your repo
        const rawContentUrl = `https://raw.githubusercontent.com/${githubRepoOwner}/${githubRepoName}/main/${githubRepoPath}`;

        // Function to display error message
        function showErrorMessage(message) {
            errorMessageElement.textContent = message;
            errorMessageElement.classList.remove('hidden');
            setTimeout(() => {
                errorMessageElement.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // Function to display a success message
        function showSuccessMessage(message) {
            successMessageElement.textContent = message;
            successMessageElement.classList.remove('hidden');
            setTimeout(() => {
                successMessageElement.classList.add('hidden');
            }, 3000); // Hide after 3 seconds
        }

        // Function to initialize AR.js and A-Frame
        async function initAR() {
            if (arInitialized) return;

            // Check for WebXR support (optional, for future expansion)
            if (!navigator.xr) {
                showErrorMessage('WebXR is not supported in this browser.');
                return;
            }

            // Setup A-Frame scene
            const scene = document.createElement('a-scene');
            scene.setAttribute('id', 'ar-scene');
            scene.setAttribute('embedded', ''); // Use embedded mode for easier integration
            scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false; detectionMode: mono;'); //minimalUI

            // Create a camera
            const camera = document.createElement('a-camera');
            camera.setAttribute('id', 'ar-camera');
            camera.setAttribute('position', '0 0 0');
            scene.appendChild(camera);

            arScene.parentElement.appendChild(scene); // Append the scene to the container

            arInitialized = true;
            return scene;
        }

        // Function to load 3D model from GitHub
        function loadModel(modelName) {
            if (modelLoaded) return;
            const modelUrl = `${rawContentUrl}${modelName}`;
            console.log('Loading model from:', modelUrl);

            let scene = document.querySelector('a-scene');

            if (!scene) {
                scene = initAR();
            }
            // Use Three.js GLTFLoader to load the model
            const loader = new THREE.GLTFLoader();
            loader.load(modelUrl,
                (gltf) => {
                    // Model loaded successfully
                    gltfModel = gltf.scene;

                    // Add the model to the scene
                    const modelEntity = document.createElement('a-entity');
                    modelEntity.setAttribute('gltf-model', modelUrl);
                    modelEntity.setAttribute('scale', '0.1 0.1 0.1');  // Adjust scale as needed
                    modelEntity.setAttribute('position', '0 0 0'); // Initial position
                    scene.appendChild(modelEntity);

                    modelLoaded = true;
                    scanningOverlay.style.display = 'none'; // Hide the scanning overlay
                    showSuccessMessage(`Model "${modelName}" loaded!`);
                },
                (xhr) => {
                    // Progress indication (optional)
                    console.log(`${(xhr.loaded / xhr.total) * 100}% loaded`);
                },
                (error) => {
                    // Handle model loading error
                    console.error('Error loading model:', error);
                    showErrorMessage(`Error loading model: ${error.message}`);
                    modelLoadErrorMessageElement.textContent = `Error loading model: ${error.message}`;
                    modelLoadErrorMessageElement.classList.remove('hidden');
                }
            );
        }

        // Function to start the QR code scanning process
        async function startScanning() {
            try {
                // Get user media (video stream)
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoFeed.srcObject = stream;
                videoFeed.onloadedmetadata = () => {
                    videoFeed.play();
                };

                // Initialize AR.js
                const scene = await initAR();

                // Setup QR code tracking using tracking.js
                const qrTracker = new tracking.Tracker('qr');
                qrTracker.on('track', (event) => {
                    if (event.data.length > 0) {
                        // QR code found!
                        const qrCodeData = event.data[0].data;
                        console.log('QR Code Data:', qrCodeData);
                        if (!qrCodeFound) {
                            qrCodeFound = true;
                            modelName = qrCodeData; //set the model name
                            loadModel(qrCodeData); // Load the model
                            // Stop video stream and tracking
                            const stream = videoFeed.srcObject;
                            const tracks = stream.getTracks();
                            tracks.forEach(track => track.stop());
                            // Remove the video feed
                            videoFeed.srcObject = null;
                        }
                    }
                });

                // Start tracking the video stream for QR codes
                const trackingInterval = setInterval(() => {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = videoFeed.videoWidth;
                    canvas.height = videoFeed.videoHeight;
                    context.drawImage(videoFeed, 0, 0, videoFeed.videoWidth, videoFeed.videoHeight);
                    const imageData = context.getImageData(0, 0, videoFeed.videoWidth, videoFeed.videoHeight);
                    qrTracker.track(imageData.data, videoFeed.videoWidth, videoFeed.videoHeight);
                }, 250); // Check for QR codes every 250ms

            } catch (error) {
                console.error('Error starting scanning:', error);
                showErrorMessage(`Error starting scanning: ${error.message}`);
            }
        }

        // Initialize the AR experience when the page loads
        window.addEventListener('load', () => {
            startScanning();
        });
    </script>
</body>
</html>
